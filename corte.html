<!DOCTYPE html>
<html lang="pt_BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Comemore seu aniversário conosco">
    <meta property="og:title" content="B-Day Inova Bar">
    <meta property="og:description" content="Comemore seu aniversário conosco">
    <meta property="og:image" content="https://firebasestorage.googleapis.com/v0/b/blacknight-600de.appspot.com/o/inovabar%2Fbday.png?alt=media&token=488b45f5-3478-496a-bc83-71e15111a36c">

    <title>B-day Inova Bar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="crooper/cropper.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.2.0/mdb.min.css" rel="stylesheet" />

    <style>
        body {
            background-color: rgb(0, 0, 0);
            color: aliceblue;
        }

        h1 {
            color: aliceblue;
        }

        label {
            color: rgb(135, 135, 135);
        }

        .label {
            cursor: pointer;
        }

        .progress {
            display: none;
            margin-bottom: 1rem;
        }

        .alert {
            display: none;
        }

        .img-container img {
            max-width: 100%;
        }

        .container,
        .container-fluid,
        .container-lg,
        .container-md,
        .container-sm,
        .container-xl {
            width: 90%;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgb(43, 43, 43);
            border-radius: 20px;
        }

        .cropper-view-box,
        .cropper-face {
            border-radius: 50%;
        }

        .cropper-point.point-se {
            bottom: -3px;
            cursor: nwse-resize;
            height: 30px;
            opacity: 1;
            right: -3px;
            width: 30px;
            border-radius: 50%;
        }

        .rounded {
            border-radius: 50% !important;
            height: 160px;
        }

        .modal-content {
            background-color: #1f1f1f;
        }

        .modal-dialog {
            position: relative;
            width: auto;
            margin: 0px;
            pointer-events: none;
        }

        .modal-body {
            position: relative;
            flex: 1 1 auto;
            padding: 1rem 2rem 1rem 2rem;
        }

        .modal-header {
            border-bottom: 2px solid #424141;
        }

        .modal-footer {
            border-top: 2px solid #424141;
        }

        .form-outline .form-control~.form-label {
            color: #e0e0e0;
        }

        .cropper-modal {
            background-color: #000000;
            opacity: 0.9;
        }

        .cropper-wrap-box,
        .cropper-canvas,
        .cropper-drag-box,
        .cropper-crop-box,
        .cropper-modal {
            border-radius: 20px;
        }

        .cropper-container {
            border-radius: 20px;
        }

        /* Estilo da pré-visualização da festa */
        .event-preview {
            background-color: #1c1c1c;
            border-radius: 20px;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .event-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
        }

        .event-preview .event-details {
            flex: 1;
        }

        .event-preview .event-date {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .event-preview .event-description {
            font-size: 14px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>

    <style type="text/css">
        @font-face {
            font-family: Roboto;
            src: url("chrome-extension://mcgbeeipkmelnpldkobichboakdfaeon/css/Roboto-Regular.ttf");
        }
    </style>
</head>

<body>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCLEyAd_4-2n2ID0xTjwS1ouip9G9C6JDs",
            authDomain: "blacknight-600de.firebaseapp.com",
            databaseURL: "https://blacknight-600de.firebaseio.com",
            projectId: "blacknight-600de",
            storageBucket: "blacknight-600de.appspot.com",
            messagingSenderId: "588926432348",
            appId: "1:588926432348:web:47b2b4a1b421d4b2a0e299",
            measurementId: "G-559VYPVJ5Q"
        };

        firebase.initializeApp(firebaseConfig);

        // Extrair o UID da URL
        const { search } = window.location;
        const params = new URLSearchParams(search);
        const pegaA = params.get('a');
        const pathParts = pegaA.split('/');
        const eventPath = pathParts[0] + '/' + pathParts[1]; // Ex.: "inovabar/eventos"
        const eventId = pathParts[2]; // Ex.: "-OJTJ0ASXwREwt9WQaEP"

        // Função para obter o dia da semana em formato abreviado
        function getDiaSemana(data) {
            var dias = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB'];
            return dias[new Date(data).getDay()];
        }

        // Função para formatar o mês em texto (ex.: MAR)
        function getMesAbrev(data) {
            var meses = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];
            return meses[new Date(data).getMonth()];
        }

        // Função para formatar a data e descrição no estilo desejado
        function formatEventDisplay(data, descricao) {
            var dia = new Date(data).getDate().toString().padStart(2, '0');
            var mes = getMesAbrev(data);
            var hora = new Date(data).toLocaleTimeString('pt-BR', { hour: '2-digit' }) + 'H';
            var diaSemana = getDiaSemana(data);
            return { date: `${diaSemana} ${dia}.${mes} ${hora}`, description: descricao || 'Sem descrição' };
        }

        // Carregar dados da festa para a pré-visualização
        function loadEventPreview() {
            var eventRef = firebase.database().ref(`${eventPath}/${eventId}`);
            eventRef.once('value', function(snapshot) {
                var evento = snapshot.val();
                if (evento) {
                    var formatted = formatEventDisplay(evento.data, evento.descricao);
                    var previewHtml = `
                        <div class="event-preview">
                            <img src="${evento.flyer || ''}" onerror="this.style.display='none'" alt="Flyer da festa" loading="lazy">
                            <div class="event-details">
                                <span class="event-date">${formatted.date}</span>
                                <div class="event-description">${formatted.description}</div>
                            </div>
                        </div>
                    `;
                    document.querySelector('.container').insertAdjacentHTML('afterbegin', previewHtml);
                }
            }, function(error) {
                console.error("Erro ao carregar dados da festa:", error);
            });
        }

        $(document).ready(function () {
            $('#whats').on('input', function () {
                $('#crop').prop('disabled', $('#apelido').val().length < 2 || $('#whats').val().length < 3);
            });
        });

        window.addEventListener('DOMContentLoaded', function () {
            var avatar = document.getElementById('avatar');
            var image = document.getElementById('image');
            var input = document.getElementById('input');

            var $progress = $('.progress');
            var $progressBar = $('.progress-bar');
            var $alert = $('.alert');
            var $modal = $('#modal');
            var cropper;

            $('[data-toggle="tooltip"]').tooltip();

            // Carregar pré-visualização da festa ao iniciar
            loadEventPreview();

            input.addEventListener('change', function (e) {
                var files = e.target.files;
                var done = function (url) {
                    input.value = '';
                    image.src = url;
                    $alert.hide();
                    $modal.modal('show');
                };
                var reader;
                var file;
                var url;

                if (files && files.length > 0) {
                    file = files[0];

                    if (URL) {
                        done(URL.createObjectURL(file));
                    } else if (FileReader) {
                        reader = new FileReader();
                        reader.onload = function (e) {
                            done(reader.result);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });

            $modal.on('shown.bs.modal', function () {
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 3,
                });
            }).on('hidden.bs.modal', function () {
                cropper.destroy();
                cropper = null;
            });

            document.getElementById('crop').addEventListener('click', function () {
                var initialAvatarURL;
                var canvas;

                $modal.modal('hide');

                if (cropper) {
                    canvas = cropper.getCroppedCanvas({
                        width: 160,
                        height: 160,
                    });

                    initialAvatarURL = avatar.src;
                    avatar.src = canvas.toDataURL();
                    $progress.hide();
                    $alert.removeClass('alert-success alert-warning');
                    canvas.toBlob(function (blob) {
                        var formData = new FormData();

                        formData.append('avatar', blob, 'avatar.jpg');

                        firebase
                            .database()
                            .ref(`${pegaA}/bday`)
                            .push({
                                aprovado: false,
                                apelido: 'apelido'
                            })
                            .once('value', (snap) => {
                                var idVal = snap.val();
                                var idFoto = snap.key;

                                console.log(`id foto é ${snap.key}`);

                                const anoAtual = new Date().getFullYear();

                                const base64 = avatar.src.split('base64,')[1];
                                firebase.storage().ref(`bday${anoAtual}/${snap.key}.png`).putString(base64, 'base64', { contentType: 'image/png' }).then(snapshot => {
                                    console.log('snapshot', snapshot);

                                    firebase.storage().ref(`bday${anoAtual}/${snap.key}.png`).getDownloadURL().then(url => {
                                        console.log('endereço', url);

                                        var apelido = document.getElementById('apelido').value;
                                        var nome = document.getElementById('nome').value;
                                        var data = document.getElementById('data').value;
                                        var whats = document.getElementById('whats').value;

                                        var promo1 = `Com 20 pagantes, ${apelido} ganha entrada VIP com acompanhante e R$100 de consumo para todos os Shows de 2025 + 1 garrafa de (Red Label, ou Bombay, ou Smirnoff) + 1 Balde de Heineken com 6 long neck.`;

                                        firebase.database()
                                            .ref(`${pegaA}/bday/${snap.key}`)
                                            .set({
                                                foto: url,
                                                aprovado: false,
                                                apelido: 'B-day ' + apelido,
                                                nome: nome,
                                                promocao: 'B-day ' + apelido,
                                                bday: data,
                                                whats: whats,
                                                status: 'Aniversariante',
                                                regra: promo1
                                            });

                                        window.open(`https://lista.inovabar.com.br/?p=${pegaA}/bday/${snap.key}`, '_top');
                                    });
                                });
                            })
                            .then(() => {
                                console.log('Foi Gravado');
                                document.getElementById('mApelido').innerHTML = apelido.value;
                            })
                            .catch(error => {
                                console.error('Hi fodeu!: ', error);
                            });
                    });
                }
            });
        });
    </script>

    <!-- MDB -->
    <script src="https://unpkg.com/jquery@3/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/bootstrap@4/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="crooper/cropper.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/4.2.0/mdb.min.js"></script>
</body>
</html>
